version: "3.9"

services:
  db:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_DATABASE:-hr_recruitment}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  app:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./:/app
    environment:
      NODE_ENV: production
      NPM_CONFIG_PRODUCTION: "false" # install dev deps (nest CLI) for build/migrations
      DB_HOST: db
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_DATABASE: ${DB_DATABASE:-hr_recruitment}
      TYPEORM_LOGGING: "false"
    depends_on:
      - db
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        until nc -z db 5432; do sleep 2; done &&
        npm ci --include=dev &&
        npm run build &&
        npx typeorm-ts-node-commonjs migration:run -d typeorm.migration.config.ts &&
        if [ -f dist/main.js ]; then
          node dist/main.js;
        elif [ -f dist/src/main.js ]; then
          node dist/src/main.js;
        else
          echo 'main.js not found in dist'; ls -R dist; exit 1;
        fi
      "

volumes:
  pgdata:


